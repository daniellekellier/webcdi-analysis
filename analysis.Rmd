---
title: Comparison of Web-CDI Data Collected from Amazon Mechanical Turk against Data
  from Aggregated CDI studies
author: ''
date: '`r Sys.Date()`'
output:
  html_document:
    toc: yes
  html_notebook:
    code_folding: hide
    highlight: tango
    theme: spacelab
    toc: yes
  pdf_document:
    toc: yes
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```


Load up necessary packages and scripts for accessing both the Wordbank MySQL database and the Web-CDI database.

```{r}
library(tidyverse)
library(quantregGrowth)
library(wordbankr)
library(langcog)
library(stringr)
library(RPostgreSQL)
library(lubridate)
library(robustbase)
library(forcats)
theme_set(theme_mikabr(base_size = 16) + theme(panel.border = element_rect(fill = NA) ))

source("access-webcdi.R")
source("predictQR_fixed.R")
mode <- "remote"
compare_newest_studies <- F
newest_studies <- "MTurk-5"
# taus <- seq(0.01,0.99, 0.01)
taus <-  c(0.1, 0.25, 0.5, 0.75, 0.9)



```

Word categories classified into nouns and verbs
```{r}
nouns <- c("animals", "vehicles","toys","food_drink","clothing","body_parts","furniture_rooms","household","outside","people")
verbs <- c("action_words","helping_verbs")
```


Collect data from wordbank.
```{r}
num_words <- get_item_data() %>%
  filter(type == "word") %>%
  group_by(language, form) %>%
  summarise(n = n())

vocab_data <- get_administration_data() %>%
  select(data_id, language, form, age, sex, 
         mom_ed, birth_order, production, comprehension, source_name) %>% 
  left_join(num_words) %>%
  mutate(no_production = n - production)

min_age <- min(vocab_data$age)
max_age <- max(vocab_data$age)
```

Functions for modelling quantiles for Wordbank data.
```{r}

fit_gcrq <- function(x) {
  mod <- try(gcrq(formula = mean ~ ps(age, monotone = 1, 
                                      lambda = 1000), 
                  tau = taus, data = x))

  if(inherits(mod, "try-error"))
  {
    return(NA)
  }

  return(mod)
}

pred_gcrq <- function(x, mods) {
  mod <- mods[[x$language[1]]]

  if (is.na(mod[1])) {
    return(expand.grid(age = x$age, 
                       language = x$language[1], 
                       percentile = as.character(taus*100), 
                       pred = NA))
  } else {
    preds <- predictQR_fixed(mod, 
                             newdata = x) %>%
      data.frame %>%
      mutate(age = x$age, 
             language = x$language) %>%
      gather(percentile, pred, starts_with("X")) %>%
      mutate(percentile = as.character(as.numeric(str_replace(percentile, 
                                                              "X", "")) 
                                       * 100))
    return(preds)
  }
}

fit_sex <- function(x) {
  robustbase::glmrob(cbind(production, no_production) ~ age * sex - sex,
                     family = "binomial",
                     data = x)
}

pred_sex_language <- function(x, model) {
  x$pred <- predict(model[[x$language[1]]], 
                    newdata = x, type = "response")
  return(x)
}

pred_sex_source <- function(x, model) {
  x$pred <- predict(model[[x$source[1]]], 
                    newdata = x, type = "response")
  return(x)
}

fit_ses <- function(x) {
  robustbase::glmrob(cbind(production, no_production) ~ 
                       age * mom_ed  - mom_ed,
                     family = "binomial",
                     data = x)
}

pred_ses_language <- function(x, model) {
  x$pred <- predict(model[[x$language[1]]], 
                    newdata = x, type = "response")
  return(x)
}

pred_ses_source <- function(x, model) {
  x$pred <- predict(model[[x$source[1]]], 
                    newdata = x, type = "response")
  return(x)
}

```

Grab English WG comprehension data from Wordbank and plot alone with model
```{r}
comp_data <- vocab_data %>%
  filter(form == "WG" &  language == "English") %>%
  mutate(mean = comprehension / n)

comp_models <- comp_data %>%
  split(.$language) %>%
  map(fit_gcrq) 

comp_preds <- comp_data %>%
  group_by(language, age) %>%
  summarise(n = n()) %>%
  data.frame() %>%
  split(.$language) %>%
  map_df(function(x) pred_gcrq(x, comp_models)) 

wordbank_comprehension_plot <- ggplot(comp_data,
       aes(x = age, y = mean)) +
  facet_wrap(~language) +
  geom_jitter(width = .4, size = 1, alpha = .1) +
  geom_line(data = comp_preds, 
            aes(y = pred, col = percentile, group = percentile)) + 
  scale_colour_solarized(name="Percentile") +
  scale_x_continuous(breaks = seq(8, 18, 4),
                     limits = c(8, 18),
                     name = "Age (months)") +
  ylab("Comprehension Vocabulary\n(proportion of total words)") +
  ylim(c(0, 1)) + 
  theme(legend.position = "bottom")

# print(wordbank_comprehension_plot)

```

Grab production data from English WG and WS for Wordbank and plot data alone with model

```{r}
prod_data <- vocab_data %>%
  filter(language == "English") %>%
  mutate(mean = production / n)

prod_models <- prod_data %>%
  split(.$language) %>%
  map(fit_gcrq) 

prod_preds <- prod_data %>%
  group_by(language, age) %>%
  summarise(n = n()) %>%
  data.frame() %>%
  split(.$language) %>%
  map_df(function(x) pred_gcrq(x, prod_models)) 

wordbank_production_plot <- ggplot(prod_data,
       aes(x = age, y = mean)) +
  facet_wrap(~language) +
  geom_jitter(width = .4, size = 1, alpha = .1) +
  geom_line(data = prod_preds, 
            aes(y = pred, col = percentile, group = percentile)) + 
  scale_colour_solarized(name="Percentile") +
  scale_x_continuous(breaks = seq(8, 36, 4),
                     limits = c(8, 36),
                     name = "Age (months)") +
  ylab("Production Vocabulary\n(proportion of total words)") +
  ylim(c(0, 1)) + 
  theme(legend.position = "bottom")

# print(wordbank_production_plot)
```

Access Web-CDI database and find data from the studies of interest (labeled 'MTurk').
Grab the related CDI items. There are one set each for the two instruments.

```{r}

webcdi <- connect_to_webcdi(mode=mode)
study_info <- get_common_table(webcdi, "researcher_UI_study") %>% as.data.frame() %>% filter(grepl('MTurk', name)) %>% rename(study_id = id, instrument = instrument_id)
instruments <- unique(study_info$instrument)
study_items <- list()

for (i in 1:length(instruments)){
  temp <- get_common_table(webcdi, paste("cdi_forms", tolower(instruments[i]), sep="_")) %>% as.data.frame() %>% rename(item_ID = itemID)
  study_items[[i]] <- temp
  study_items[[i]]$instrument <- instruments[i]
}

cdi_items <- bind_rows(study_items) %>% filter(!grepl('example', item_ID))

```

Grab by-child data (administration details, demographic information, and given answers)
```{r}

admin_info <- get_common_table(webcdi, "researcher_UI_administration") %>% as.data.frame() %>% filter(study_id %in% study_info$study_id & completed) %>% rename(administration_id = id)

background_info <- get_common_table(webcdi, "cdi_forms_backgroundinfo") %>% as.data.frame() %>% filter(administration_id %in% admin_info$administration_id) %>% filter(birth_weight >= 5.5)

cdi_answers <- get_common_table(webcdi, "researcher_UI_administration_data") %>% as.data.frame() %>% filter(administration_id %in% admin_info$administration_id) %>% select(-id)

```

Merge Web-CDI tables.
Calculate proportions of words understood and words produced.
```{r}

combined_data <- left_join(background_info, admin_info, by = "administration_id") %>% left_join(., study_info, by = "study_id") %>% left_join(., cdi_items, by = c("instrument")) %>% left_join(., cdi_answers, by = c("administration_id", "item_ID")) %>% filter( grepl('WG', instrument) & (age >= 8 & age <= 18) | grepl('WS', instrument) & (age >= 16 & age <= 30))

combined_words <- combined_data %>% filter(item_type == "word")
combined_words$value[is.na(combined_words$value)] <- "neither"

combined_words$word_type[combined_words$category %in% nouns] <- "nouns"
combined_words$word_type[combined_words$category %in% verbs] <- "verbs"


```


```{r}

slim_wordbank_data <- vocab_data %>% filter(language == "English") %>% rename(id = data_id, study_group = source_name) %>% select(id, form, age, sex, study_group, mom_ed, production, comprehension, n) %>% mutate(source = "wordbank", mom_ed = fct_collapse(mom_ed, 
                               `Below Secondary` = c("None","Primary",
                                                     "Some Secondary"),
                               `Secondary` = c("Secondary", "Some College"),
                               `College and Above` = c("College", 
                                                       "Some Graduate", 
                                                       "Graduate")))

slim_webcdi_data <- combined_words %>% group_by(id, instrument, age, sex, study_group, mother_education) %>% summarise(comprehension = sum(value == "understands" | value == "produces"), production = sum(value == "produces"), n = n(), source = "webcdi", form = NA, mom_ed = NA) %>% rename(sex_old = sex) %>% mutate(sex = ifelse(sex_old == "F", "Female", ifelse(sex_old == "M", "Male", NA))) %>% select (-sex_old)

slim_webcdi_data$form[grepl('WG', slim_webcdi_data$instrument)] <- "WG"
slim_webcdi_data$form[grepl('WS', slim_webcdi_data$instrument)] <- "WS"

slim_webcdi_data$mom_ed[slim_webcdi_data$mother_education %in% 0:9] <- "Below Secondary"
slim_webcdi_data$mom_ed[slim_webcdi_data$mother_education %in% 10:13] <- "Secondary"
slim_webcdi_data$mom_ed[slim_webcdi_data$mother_education %in% 14:25] <- "College and Above"

slim_webcdi_data$instrument <- slim_webcdi_data$mother_education <- NULL

a <- list(slim_webcdi_data, slim_wordbank_data)

for (i in 1:length((a))) {
  temp <- a[[i]]
  temp <- temp[,c("source","id","form","study_group","age","sex","mom_ed","production","comprehension","n")]
  a[[i]] <- temp
  
}

both_data <- bind_rows(a) %>% mutate(no_production = (n-production))

```

Plot Wordbank data with Web-CDI data (in red) along with the original model lines.

```{r}

if (compare_newest_studies) {
  combined_words$newest <- FALSE
  combined_words$newest[combined_words$study_group == newest_studies] <- TRUE
  
  prop_measures <- combined_words %>% group_by(id, age, newest) %>% summarise(comprehension = sum(value == "understands" | value == "produces")/n(), production = sum(value == "produces")/n())
  
  prop_measures_old <- prop_measures %>% filter(!newest)
  prop_measures_new <- prop_measures %>% filter(newest)
} else {
    prop_measures <- combined_words %>% group_by(id, age) %>% summarise(comprehension = sum(value == "understands" | value == "produces")/n(), production = sum(value == "produces")/n())
}


combined_comprehension_plot <- ggplot(comp_data,
       aes(x = age, y = mean)) +
  facet_wrap(~language) +
  geom_jitter(width = .4, size = 1, alpha = .1) +
  geom_line(data = comp_preds, 
            aes(y = pred, col = percentile, group = percentile))

  if (compare_newest_studies) {
    combined_comprehension_plot <- combined_comprehension_plot + geom_jitter(width = .4, size = 1, alpha = .6, colour = "#249D00", data=prop_measures_old, aes(x = age, y = comprehension)) +
    geom_jitter(width = .6, size = 1, alpha = .6, colour = "red", data=prop_measures_new, aes(x = age, y = comprehension))
  } else{
    combined_comprehension_plot <- combined_comprehension_plot + geom_jitter(width = .4, size = 1, alpha = .6, colour = "red", data=prop_measures, aes(x = age, y = comprehension))
  }
  
  combined_comprehension_plot <- combined_comprehension_plot + scale_colour_solarized(name="Percentile") +
  scale_x_continuous(breaks = seq(8, 18, 4),
                     limits = c(8, 18),
                     name = "Age (months)") +
  ylab("Comprehension Vocabulary\n(proportion of total words)") +
  ylim(c(0, 1)) + 
  theme(legend.position = "bottom")

  print(combined_comprehension_plot)


combined_production_plot <- ggplot(prod_data,
       aes(x = age, y = mean)) +
  facet_wrap(~language) +
  geom_jitter(width = .4, size = 1, alpha = .1) + 
  geom_line(data = prod_preds, 
            aes(y = pred, col = percentile, group = percentile))

  if (compare_newest_studies) {
    combined_production_plot <- combined_production_plot + geom_jitter(width = .4, size = 1, alpha = .6, colour = "#249D00", data=prop_measures_old, aes(x = age, y = production)) +
  geom_jitter(width = .4, size = 1, alpha = .6, colour = "red", data=prop_measures_new, aes(x = age, y = production))
    
  } else {
    combined_production_plot <- combined_production_plot + geom_jitter(width = .4, size = 1, alpha = .6, colour = "red", data=prop_measures, aes(x = age, y = production))
  }

  combined_production_plot <- combined_production_plot + scale_colour_solarized(name="Percentile") +
  scale_x_continuous(breaks = seq(8, 30, 4),
                     limits = c(8, 30),
                     name = "Age (months)") +
  ylab("Production Vocabulary\n(proportion of total words)") +
  ylim(c(0, 1)) + 
  theme(legend.position = "bottom")

  print(combined_production_plot)

```

```{r}

binned_data <- both_data %>% group_by(id, age, form, source) %>% summarise(prop_prod = mean(production/n)) 

binned_data$`% of Words Produced`[binned_data$prop_prod < 0.25] <- "0-25%"
binned_data$`% of Words Produced`[binned_data$prop_prod >= 0.25 & binned_data$prop_prod < 0.50] <- "25-50%"
binned_data$`% of Words Produced`[binned_data$prop_prod >= 0.50 & binned_data$prop_prod < 0.75] <- "50-75%"
binned_data$`% of Words Produced`[binned_data$prop_prod >= 0.75] <- "75-100%"

binned_production_comparison_plot <- ggplot(binned_data, aes(age, fill=`% of Words Produced`)) + geom_bar(position = "fill", width=0.9) + facet_wrap(~source) + labs(y = "Production Vocabulary\n(proportion of total words)", x="Age (months)") + theme(legend.position = "bottom")

print(binned_production_comparison_plot)

```


```{r}

taus <- seq(0.01,0.99, 0.01)

prod_models_perc <- prod_data %>%
  split(.$language) %>%
  map(fit_gcrq) 

prod_preds_perc <- prod_data %>%
  group_by(language, age) %>%
  summarise(n = n()) %>%
  data.frame() %>%
  split(.$language) %>%
  map_df(function(x) pred_gcrq(x, prod_models_perc)) 

prop_prod <- both_data  %>% group_by(age) %>% filter(study_group %in% c("MTurk-3","MTurk-4","MTurk-5") | source == "wordbank") %>% mutate(prop_production = production/n, quantile = NA)


for (i in 1:nrow(prop_prod)) {
  current_age <- prop_prod$age[i]
  current_prod <- prop_prod$prop_production[i]
  
  ranges_at_age <- prod_preds_perc %>% filter(age == current_age, pred < current_prod)
  
  prop_prod$quantile[i] <- max(max(as.numeric(as.character(ranges_at_age$percentile))),1)
  
  
}


prop_prod$quantile[prop_prod$production == 0] <- 0
prop_prod$bin_quantile <- as.character(cut(prop_prod$quantile, seq(0,100, 25), labels = c("1-25th","26-50th","51-75th","76-100th")))
prop_prod$bin_quantile[prop_prod$production == 0] <- "Did not produce"

webcdi_prop_prod <- prop_prod %>% filter(source == "webcdi")
wordbank_prop_prod <- prop_prod %>% filter(source == "wordbank")

prop_prod_perc <- prop_prod %>% 
  group_by(source,bin_quantile) %>% 
  summarise(n=n()) %>% 
  group_by(source) %>% 
  mutate(perc=n/sum(n))

combined_ranking_overall <- ggplot(prop_prod_perc, aes(x = factor(bin_quantile), y= perc, fill=factor(bin_quantile))) + facet_wrap(~source) + geom_bar(stat="identity")+ scale_y_continuous(breaks = seq(0,1,0.25), labels = scales::percent) + labs(x = "Production Percentile Ranking Against Wordbank Data", fill="", y="% of Web-CDI Population") + theme(legend.position = "bottom", axis.text.x = element_blank(), axis.ticks.x = element_blank())

combined_ranking_study_age <- ggplot(prop_prod, aes(age, fill=factor(bin_quantile))) + geom_bar(position = "fill", width=0.9) + facet_wrap(~source) + scale_y_continuous(breaks = seq(0,1,0.25), labels = scales::percent) + labs(fill = "Production Percentile Ranking\nAgainst Wordbank Data", y = "Proportion of Population", x = "Age (months)") + theme(legend.position = "bottom")

 ggplot(prop_prod, aes(age, fill=factor(bin_quantile))) + geom_bar(position = "fill", width=0.9) + facet_wrap(~source + study_group, nrow = 2) + scale_y_continuous(breaks = seq(0,1,0.25), labels = scales::percent) + labs(fill = "Production Percentile Ranking\nAgainst Wordbank Data", y = "Proportion of Population", x = "Age (months)") + theme(legend.position = "bottom")

ggplot(webcdi_prop_prod, aes(factor(bin_quantile), fill=factor(bin_quantile))) + geom_bar(aes(y = (..count..)/sum(..count..)))+ scale_y_continuous(breaks = seq(0,1,0.25), labels = scales::percent) + labs(x = "Production Percentile Ranking Against Wordbank Data", fill="", y="% of Web-CDI Population") + theme(legend.position = "bottom")

webcdi_ranking_study_age <- ggplot(webcdi_prop_prod, aes(age, fill=factor(bin_quantile))) + geom_bar(position = "fill", width=0.9) + facet_wrap(~study_group) + scale_y_continuous(breaks = seq(0,1,0.25), labels = scales::percent) + labs(fill = "Production Percentile Ranking\nAgainst Wordbank Data", y = "Proportion of Population", x = "Age (months)") + theme(legend.position = "bottom")

wordbank_ranking_study_age <- ggplot(wordbank_prop_prod, aes(age, fill=factor(bin_quantile))) + geom_bar(position = "fill", width=0.9) + facet_wrap(~study_group) + scale_y_continuous(breaks = seq(0,1,0.25), labels = scales::percent) + labs(fill = "Production Percentile Ranking", x="Age (months)", y="Proportion of Population") + theme(legend.position = "bottom")

```




```{r}

#currently not enough subjects in webcdi data with mom_ed = "below secondary", skewing results
ses_data <- both_data #%>% filter(mom_ed != "Below Secondary" | source == "wordbank")

ses_means <- ses_data %>%
  group_by(mom_ed, age, source) %>% mutate(mean_production = production/n) %>%
  summarise(median = median(mean_production), n = n())

ses_models <- ses_data %>%
  split(.$source) %>%
  map(fit_ses) 

ses_preds <- expand.grid(source = unique(ses_means$source), 
                         age = min(ses_means$age):max(ses_means$age), 
                         mom_ed = unique(ses_means$mom_ed)) %>%
  split(.$source) %>%
  map_df(pred_ses_source, model = ses_models)

ses_plot <- ggplot(ses_means,
       aes(x = age, y = median, colour = mom_ed, label = mom_ed)) +
  facet_wrap(~source) +
  geom_point(alpha=.2) +
  geom_line(data = ses_preds, aes(y = pred)) + 
  scale_colour_solarized(name="Maternal Education") +
  scale_x_continuous(breaks = seq(min(ses_means$age), 
                                  max(ses_means$age), 4),
                     limits = c(min(ses_means$age), max(ses_means$age)),
                     name = "Age (months)") +
  ylab("Median Productive Vocabulary\n(proportion of total words)") +
  ylim(c(0, 1)) + 
  theme(legend.position = "bottom")
print(ses_plot)

```



```{r}
sex_data <- both_data %>% mutate(mean_production = production/n, source = as.factor(source))

sex_means <- sex_data %>% group_by(sex, age, source) %>% summarise(production = median(mean_production))

sex_models <- sex_data %>%
  split(.$source) %>%
  map(fit_sex) 

sex_preds <- expand.grid(source = unique(sex_means$source), 
                         age = min(sex_means$age):max(sex_means$age), 
                         sex = unique(sex_means$sex)) %>%
  split(.$source) %>%
  map_df(pred_sex_source, model = sex_models)

sex_plot <- ggplot(sex_means,
       aes(x = age, y = production, colour = sex, label = sex)) +
  facet_wrap(~source) +
  geom_point(alpha=.2) +
  geom_line(data = sex_preds, aes(y = pred)) + 
  scale_colour_solarized(name="Sex") +
  scale_x_continuous(breaks = seq(min(sex_means$age), 
                                  max(sex_means$age), 4),
                     limits = c(min(sex_means$age), max(sex_means$age)),
                     name = "Age (months)") +
  ylab("Median Productive Vocabulary\n(proportion of total words)") +
  ylim(c(0, 1)) + 
  theme(legend.position = "bottom")

print(sex_plot)
```


```{r}
object_names <- ls()
for (i in 1:length(object_names)) {
  if(is.ggplot(get(object_names[i]))) {
    ggsave(plot = get(object_names[i]), filename = paste0("graphs/",object_names[i],".png"))
  }
  
}

```

<!-- Further splitting data by word_type -->

<!-- ```{r} -->
<!-- type_measures <- combined_words %>% group_by(id, age, word_type) %>% filter(!is.na(word_type)) %>% summarise(comprehension = sum(value == "understands" | value == "produces")/n(), production = sum(value == "produces")/n()) -->

<!-- group_type_measures <- type_measures %>% group_by(age, word_type) %>% summarise(comprehension = mean(comprehension), production = mean(production)) -->

<!-- type_comprehension_plot <- ggplot(comp_data, -->
<!--        aes(x = age, y = mean)) + -->
<!--   facet_wrap(~language) + -->
<!--   geom_jitter(width = .4, size = 1, alpha = .1) + -->
<!--   geom_line(data = comp_preds,  -->
<!--             aes(y = pred, col = percentile, group = percentile)) +  -->
<!--   geom_jitter(width = .4, size = 1, alpha = .6, data=type_measures, aes(x = age, y = comprehension, colour = word_type)) + -->
<!--   scale_colour_solarized(name="Percentile") + -->
<!--   scale_x_continuous(breaks = seq(8, 18, 4), -->
<!--                      limits = c(8, 18), -->
<!--                      name = "Age (months)") + -->
<!--   ylab("Comprehension Vocabulary\n(proportion of total words)") + -->
<!--   ylim(c(0, 1)) +  -->
<!--   theme(legend.position = "bottom") -->

<!-- print(type_comprehension_plot) -->


<!-- type_production_plot <- ggplot(prod_data, -->
<!--        aes(x = age, y = mean)) + -->
<!--   facet_wrap(~language) + -->
<!--   geom_jitter(width = .4, size = 1, alpha = .1) +  -->
<!--   geom_line(data = prod_preds,  -->
<!--             aes(y = pred, col = percentile, group = percentile)) +  -->
<!--   geom_jitter(width = .4, size = 1, alpha = .6, data=type_measures, aes(x = age, y = production, colour = word_type)) + -->
<!--   scale_colour_solarized(name="Percentile") + -->
<!--   scale_x_continuous(breaks = seq(8, 30, 4), -->
<!--                      limits = c(8, 30), -->
<!--                      name = "Age (months)") + -->
<!--   ylab("Production Vocabulary\n(proportion of total words)") + -->
<!--   ylim(c(0, 1)) +  -->
<!--   theme(legend.position = "bottom") -->

<!-- print(type_production_plot) -->
<!-- ``` -->




<!-- Sex differences in English Wordbank Data -->
<!-- ```{r} -->

<!-- wordbank_sex_data <- vocab_data %>% -->
<!--   filter(!is.na(sex), language == "English")  -->

<!-- wordbank_sex_means <- wordbank_sex_data %>% -->
<!--   group_by(language, sex, age) %>% -->
<!--   summarise(median = median(production/n)) -->

<!-- wordbank_sex_models <- wordbank_sex_data %>% -->
<!--   split(.$language) %>% -->
<!--   map(fit_sex)  -->

<!-- wordbank_sex_preds <- expand.grid(language = unique(wordbank_sex_means$language),  -->
<!--                          age = min_age:max_age,  -->
<!--                          sex = unique(wordbank_sex_means$sex)) %>% -->
<!--   split(.$language) %>% -->
<!--   map_df(pred_sex_language, model = wordbank_sex_models) -->

<!-- wordbank_sex_plot <- ggplot(wordbank_sex_means, -->
<!--        aes(x = age, y = median, colour = sex, label = sex)) + -->
<!--   facet_wrap(~language) + -->
<!--   geom_point(alpha=.2) + -->
<!--   geom_line(data = wordbank_sex_preds, aes(y = pred)) +  -->
<!--   scale_colour_solarized(name="Sex") + -->
<!--   scale_x_continuous(breaks = seq(min(wordbank_sex_means$age),  -->
<!--                                   max(wordbank_sex_means$age), 4), -->
<!--                      limits = c(min(wordbank_sex_means$age), max(wordbank_sex_means$age)), -->
<!--                      name = "Age (months)") + -->
<!--   ylab("Median Productive Vocabulary\n(proportion of total words)") + -->
<!--   ylim(c(0, 1)) +  -->
<!--   theme(legend.position = "bottom") -->

<!-- print(wordbank_sex_plot) -->

<!-- ``` -->

<!-- Sex differences in Web-CDI Data -->

<!-- ```{r} -->
<!-- webcdi_sex_data <- combined_words %>% filter(sex %in% c("M","F")) %>% group_by(id, sex, age) %>% summarise(production = sum(value == "produces"), no_production = sum(value != "produces"), mean_production = sum(value == "produces")/n(), language = "English") -->

<!-- webcdi_sex_data$sex[webcdi_sex_data$sex == "F"] <- "Female" -->
<!-- webcdi_sex_data$sex[webcdi_sex_data$sex == "M"] <- "Male" -->

<!-- webcdi_sex_means <- webcdi_sex_data %>% group_by(sex, age, language) %>% summarise(production = median(mean_production)) -->

<!-- webcdi_sex_models <- webcdi_sex_data %>% -->
<!--   split(.$language) %>% -->
<!--   map(fit_sex)  -->

<!-- webcdi_sex_preds <- expand.grid(language = unique(webcdi_sex_means$language),  -->
<!--                          age = min(webcdi_sex_means$age):max(webcdi_sex_means$age),  -->
<!--                          sex = unique(webcdi_sex_means$sex)) %>% -->
<!--   split(.$language) %>% -->
<!--   map_df(pred_sex_language, model = webcdi_sex_models) -->

<!-- webcdi_sex_plot <- ggplot(webcdi_sex_means, -->
<!--        aes(x = age, y = production, colour = sex, label = sex)) + -->
<!--   facet_wrap(~language) + -->
<!--   geom_point(alpha=.2) + -->
<!--   geom_line(data = webcdi_sex_preds, aes(y = pred)) +  -->
<!--   scale_colour_solarized(name="Sex") + -->
<!--   scale_x_continuous(breaks = seq(min(webcdi_sex_means$age),  -->
<!--                                   max(webcdi_sex_means$age), 4), -->
<!--                      limits = c(min(webcdi_sex_means$age), max(webcdi_sex_means$age)), -->
<!--                      name = "Age (months)") + -->
<!--   ylab("Median Productive Vocabulary\n(proportion of total words)") + -->
<!--   ylim(c(0, 1)) +  -->
<!--   theme(legend.position = "bottom") -->

<!-- print(webcdi_sex_plot) -->
<!-- ``` -->

<!-- Looking at traditional Wordbank Data for Maternal Education Differences -->

<!-- ```{r} -->
<!-- wordbank_ses_data <- vocab_data %>% -->
<!--   filter(!is.na(mom_ed), language == "English") %>% -->
<!--   mutate(mom_ed = fct_collapse(mom_ed,  -->
<!--                                `Below Secondary` = c("None","Primary", -->
<!--                                                      "Some Secondary"), -->
<!--                                `Secondary` = c("Secondary", "Some College"), -->
<!--                                `College and Above` = c("College",  -->
<!--                                                        "Some Graduate",  -->
<!--                                                        "Graduate"))) -->

<!-- wordbank_ses_means <- wordbank_ses_data %>% -->
<!--   group_by(language, mom_ed, age) %>% -->
<!--   summarise(median = median(production/n)) -->

<!-- wordbank_ses_models <- wordbank_ses_data %>% -->
<!--   split(.$language) %>% -->
<!--   map(fit_ses)  -->

<!-- wordbank_ses_preds <- expand.grid(language = unique(wordbank_ses_means$language),  -->
<!--                          age = min_age:max_age,  -->
<!--                          mom_ed = unique(wordbank_ses_means$mom_ed)) %>% -->
<!--   split(.$language) %>% -->
<!--   map_df(pred_ses_language, model = wordbank_ses_models) -->

<!-- wordbank_ses_plot <- ggplot(wordbank_ses_means, -->
<!--        aes(x = age, y = median, colour = mom_ed, label = mom_ed)) + -->
<!--   facet_wrap(~language) + -->
<!--   geom_point(alpha=.2) + -->
<!--   geom_line(data = wordbank_ses_preds, aes(y = pred)) +  -->
<!--   scale_colour_solarized(name="Maternal Education") + -->
<!--   scale_x_continuous(breaks = seq(min(wordbank_ses_means$age),  -->
<!--                                   max(wordbank_ses_means$age), 4), -->
<!--                      limits = c(min(wordbank_ses_means$age), max(wordbank_ses_means$age)), -->
<!--                      name = "Age (months)") + -->
<!--   ylab("Median Productive Vocabulary\n(proportion of total words)") + -->
<!--   ylim(c(0, 1)) +  -->
<!--   theme(legend.position = "bottom") -->

<!-- print(wordbank_ses_plot) -->

<!-- ``` -->

<!-- Comparison of Web-CDI SES Data. -->

<!-- ```{r} -->

<!-- webcdi_ses_data <- combined_words %>% -->
<!--   filter(!is.na(mother_education)) %>% group_by(id, mother_education, age) %>% summarise(production = sum(value == "produces"), no_production = sum(value != "produces"), mean_production = sum(value == "produces")/n(), language = "English") %>% -->
<!--   rename(mom_ed = mother_education) -->

<!-- webcdi_ses_data$mom_ed[webcdi_ses_data$mom_ed %in% 0:9] <- "Below Secondary" -->
<!-- webcdi_ses_data$mom_ed[webcdi_ses_data$mom_ed %in% 10:13] <- "Secondary" -->
<!-- webcdi_ses_data$mom_ed[webcdi_ses_data$mom_ed %in% 14:25] <- "College and Above" -->

<!-- #currently not enough subjects with mom_ed = "below secondary", skewing results -->
<!-- webcdi_ses_data <- webcdi_ses_data %>% filter(mom_ed != "Below Secondary") -->

<!-- webcdi_ses_means <- webcdi_ses_data %>% -->
<!--   group_by(language, mom_ed, age) %>% -->
<!--   summarise(median = median(mean_production)) -->

<!-- webcdi_ses_models <- webcdi_ses_data %>% -->
<!--   split(.$language) %>% -->
<!--   map(fit_ses)  -->

<!-- webcdi_ses_preds <- expand.grid(language = unique(webcdi_ses_means$language),  -->
<!--                          age = min(webcdi_ses_means$age):max(webcdi_ses_means$age),  -->
<!--                          mom_ed = unique(webcdi_ses_means$mom_ed)) %>% -->
<!--   split(.$language) %>% -->
<!--   map_df(pred_ses_language, model = webcdi_ses_models) -->

<!-- webcdi_ses_plot <- ggplot(webcdi_ses_means, -->
<!--        aes(x = age, y = median, colour = mom_ed, label = mom_ed)) + -->
<!--   facet_wrap(~language) + -->
<!--   geom_point(alpha=.2) + -->
<!--   geom_line(data = webcdi_ses_preds, aes(y = pred)) +  -->
<!--   scale_colour_solarized(name="Maternal Education") + -->
<!--   scale_x_continuous(breaks = seq(min(webcdi_ses_means$age),  -->
<!--                                   max(webcdi_ses_means$age), 4), -->
<!--                      limits = c(min(webcdi_ses_means$age), max(webcdi_ses_means$age)), -->
<!--                      name = "Age (months)") + -->
<!--   ylab("Median Productive Vocabulary\n(proportion of total words)") + -->
<!--   ylim(c(0, 1)) +  -->
<!--   theme(legend.position = "bottom") -->

<!-- print(webcdi_ses_plot) -->

<!-- ``` -->


<!-- ```{r} -->

<!-- wordbank_prop_prod <- slim_wordbank_data %>% mutate(prop_production = production/n, quantile = NA) -->

<!-- for (i in 1:nrow(wordbank_prop_prod)) { -->
<!--   current_age <- wordbank_prop_prod$age[i] -->
<!--   current_prod <- wordbank_prop_prod$prop_production[i] -->

<!--   ranges_at_age <- prod_preds_perc %>% filter(age == current_age, pred < current_prod) -->

<!--   wordbank_prop_prod$quantile[i] <- max(max(as.numeric(as.character(ranges_at_age$percentile))),1) -->

<!-- } -->

<!-- wordbank_prop_prod$quantile[wordbank_prop_prod$production == 0] <- 0 -->
<!-- wordbank_prop_prod$bin_quantile <- as.character(cut(wordbank_prop_prod$quantile, seq(0,100, 25), labels = c("1-25th","26-50th","51-75th","76-100th"))) -->
<!-- wordbank_prop_prod$bin_quantile[wordbank_prop_prod$production == 0] <- "Did not produce" -->

<!-- wordbank_ranking_overall <- ggplot(wordbank_prop_prod, aes(factor(bin_quantile), fill=factor(bin_quantile))) + geom_bar(aes(y = (..count..)/sum(..count..)))  + scale_y_continuous(breaks = seq(0,1,0.25), labels = scales::percent) + labs(x = "Production Percentile Ranking Against Wordbank Data", fill="", y="% of Wordbank Population") + theme(legend.position = "bottom") -->

<!-- wordbank_ranking_study_age <- ggplot(wordbank_prop_prod, aes(age, fill=factor(bin_quantile))) + geom_bar(position = "fill", width=0.9) + facet_wrap(~study_group) + scale_y_continuous(breaks = seq(0,1,0.25), labels = scales::percent) + labs(fill = "Production Percentile Ranking", x="Age (months)", y="Proportion of Population") + theme(legend.position = "bottom") -->

<!-- ``` -->
